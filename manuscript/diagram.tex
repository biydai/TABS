%%%%%%%%%%%%%%%%%%%%%%
% pseudo code for two stage adaptive design  %
%%%%%%%%%%%%%%%%%%%%%%

\begin{algorithm}[h]
\SetKwBlock{Begin}{Stage 1}{end Stage1}
\Begin(S$\%$)
{
			\vspace{0.5cm}
			\textbf{Step 1.} Compute cross-validated AUC 
			\par \For{fold i in 1 to K \textit{(folds are stratified by status $\delta$ )}} 
			{
				\par training $\leftarrow$ observations not in fold i, fit Cox Regression and get estimates $\hat{\beta}_{-i}$
				\par testing $\leftarrow$ observations in fold i, get CV linear predictor $\hat{\eta}_{i}= X_{i}\hat{\beta}_{-i}$				
			} 
			$\hat{C}_{cv}$ $\equiv$ Harrell's C based on outcome (T, $\delta$) and CV linear predictors $\hat{\eta} = \{\hat{\eta}_{1}, \hat{\eta}_{2}, ... \hat{\eta}_{K} \}$	
		
			\vspace{0.5cm}

			\textbf{Step 2.} Obtain the null distribution of cross-validated C index via permutation (This step can be replaced by bootstrap)
			\par \For{iteration b in 1 to B}
			{
				($T_b$, $\delta_{b}$) $\leftarrow$ Sample from outcome (T, $\delta$) without replacement
				\par $\hat{C}_{0}^{(b)} \equiv$ repeat Step 1 on the permutated outcome ($T_b$, $\delta_{b}$)
			} 
			\par $\hat{F}_0$ = $\{ \hat{C}_{0}^{(1)}, \hat{C}_{0}^{(2)}, ... , \hat{C}_{0}^{(B)} \}$

		\vspace{0.5cm}	

		\textbf{Step 3.} Conduct hypothesis test
		\par \uIf{$1 - \widehat{CDF}_{0}(\hat{C}_{cv}) \leq \alpha$}
		{
			\par Continue to Stage 2 for validation
			}
		\Else
		{
			Terminate study early
		}
}

\vspace{0.5cm}

\SetKwBlock{Begin}{Stage2}{end Stage2}
\Begin(: Independent Validation on 1 - S$\%$){
	\vspace{0.5cm}
	\par \textbf{Step 1}: Rebuild Locked-down signature with all data in Stage 1
	\vspace{0.5cm}
	\par \textbf{Step 2}: Apply this signature to Stage 2 data
	\vspace{0.5cm}
	\par \textbf{Step 3}: Conduct hypothesis test on Harrell's C 
	\par (Closed form test developed by Pencina and D'Agostino (2004))
	\par \uIf{$Z_{2} > z_{1 - \alpha_2}$}{ independently validated}
	\Else
	{independent validation fails}
}
\end{algorithm}
